// ==========================================
// 🛡️ VARP SECURITY PROTECTION SYSTEM
// ==========================================

(function() {
    'use strict';
    
    // 1. Anti-iframe protection
    if (window.top !== window.self) {
        window.top.location = window.self.location;
    }
    
    // 2. User Agent validation
    const suspiciousAgents = [
        'wget', 'curl', 'bot', 'scraper', 'spider', 'crawl', 
        'download', 'grab', 'fetch', 'extract', 'copy'
    ];
    
    const userAgent = navigator.userAgent.toLowerCase();
    if (suspiciousAgents.some(agent => userAgent.includes(agent))) {
        document.body.innerHTML = '<h1>🚫 Access Denied</h1>';
        throw new Error('Suspicious user agent detected');
    }
    
    // 3. Developer tools detection
    let devToolsOpen = false;
    
    function detectDevTools() {
        const threshold = 160;
        const widthDiff = window.outerWidth - window.innerWidth;
        const heightDiff = window.outerHeight - window.innerHeight;
        
        if (widthDiff > threshold || heightDiff > threshold) {
            if (!devToolsOpen) {
                devToolsOpen = true;
                console.clear();
                console.log('%c🛡️ VARP SECURITY', 'color: red; font-size: 20px; font-weight: bold;');
                console.log('%cDeveloper tools detected! This panel is protected.', 'color: orange; font-size: 14px;');
                
                // Opcjonalnie: ukryj zawartość
                // document.body.style.filter = 'blur(10px)';
            }
        } else {
            if (devToolsOpen) {
                devToolsOpen = false;
                // document.body.style.filter = 'none';
            }
        }
    }
    
    // 4. Context menu protection
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        console.log('🛡️ Right-click disabled for security');
        return false;
    });
    
    // 5. Keyboard shortcuts protection
    document.addEventListener('keydown', function(e) {
        // Disable F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S
        if (e.keyCode === 123 || // F12
            (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
            (e.ctrlKey && e.keyCode === 85) || // Ctrl+U
            (e.ctrlKey && e.keyCode === 83)) { // Ctrl+S
            e.preventDefault();
            console.log('🛡️ Keyboard shortcut blocked');
            return false;
        }
    });
    
    // 6. Console protection
    let consoleMessages = 0;
    const originalLog = console.log;
    console.log = function(...args) {
        consoleMessages++;
        if (consoleMessages > 50) {
            console.clear();
            consoleMessages = 0;
        }
        originalLog.apply(console, args);
    };
    
    // 7. Referrer check
    if (document.referrer && 
        !document.referrer.includes(window.location.hostname) && 
        document.referrer !== '') {
        console.warn('🛡️ External referrer detected:', document.referrer);
    }
    
    // 8. Screen resolution check (basic bot detection)
    if (screen.width < 100 || screen.height < 100) {
        console.error('🛡️ Suspicious screen resolution');
        document.body.innerHTML = '<h1>🚫 Invalid Display</h1>';
        throw new Error('Invalid screen resolution');
    }
    
    // 9. Check for automation tools
    if (navigator.webdriver === true) {
        console.error('🛡️ Automation detected');
        document.body.innerHTML = '<h1>🚫 Automation Not Allowed</h1>';
        throw new Error('Automation tools detected');
    }
    
    // 10. Monitor dev tools every 500ms
    setInterval(detectDevTools, 500);
    
    // 11. Initial content hiding with progressive reveal
    let securityChecked = false;
    
    function performSecurityCheck() {
        return new Promise((resolve) => {
            setTimeout(() => {
                // Check if running in legitimate browser environment
                const isLegitimate = 
                    typeof window !== 'undefined' &&
                    typeof document !== 'undefined' &&
                    typeof navigator !== 'undefined' &&
                    window.innerWidth > 0 &&
                    window.innerHeight > 0 &&
                    navigator.plugins.length >= 0;
                
                securityChecked = true;
                resolve(isLegitimate);
            }, 1000);
        });
    }
    
    // 12. Content protection
    document.addEventListener('DOMContentLoaded', async function() {
        const isSecure = await performSecurityCheck();
        
        if (!isSecure) {
            document.body.innerHTML = '<h1>🚫 Security Check Failed</h1>';
            return;
        }
        
        // Add additional protection styles
        const style = document.createElement('style');
        style.textContent = `
            body {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Hide from print */
            @media print {
                body { display: none !important; }
            }
            
            /* Anti-screenshot overlay */
            body::before {
                content: 'VARP PANEL - CONFIDENTIAL';
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                font-size: 48px;
                color: rgba(255, 0, 0, 0.03);
                z-index: 9999;
                pointer-events: none;
                white-space: nowrap;
            }
        `;
        document.head.appendChild(style);
        
        console.log('%c🛡️ VARP SECURITY ACTIVE', 'color: green; font-size: 16px; font-weight: bold;');
    });
    
    // 13. Obfuscate sensitive data
    window.VARP_SECURE = {
        encode: (str) => btoa(encodeURIComponent(str)),
        decode: (str) => decodeURIComponent(atob(str))
    };
    
    // 14. Monitor for suspicious activity
    let suspiciousActivity = 0;
    
    function logSuspiciousActivity(activity) {
        suspiciousActivity++;
        console.warn(`🛡️ Suspicious activity detected: ${activity} (Count: ${suspiciousActivity})`);
        
        if (suspiciousActivity > 10) {
            console.error('🛡️ Too much suspicious activity - initiating protection mode');
            document.body.style.filter = 'blur(20px)';
            setTimeout(() => {
                document.body.innerHTML = '<h1>🚫 Security Breach Detected</h1>';
            }, 2000);
        }
    }
    
    // 15. Network monitoring
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        const url = args[0];
        if (typeof url === 'string' && !url.includes('firebase') && !url.includes('googleapis')) {
            logSuspiciousActivity(`External fetch to: ${url}`);
        }
        return originalFetch.apply(this, args);
    };
    
    console.log('🛡️ VARP Security System Initialized');
    
})();
