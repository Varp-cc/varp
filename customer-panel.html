<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Panel - Varp</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Geologica:wght@100..900&family=Libertinus+Math&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4a90e2;
            --primary-gradient: linear-gradient(135deg, #4a90e2, #6bb6ff);
            --secondary-color: #6bb6ff;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --dark-bg: #090A0B;
            --card-bg: rgba(255, 255, 255, 0.02);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b3d9ff;
            --text-muted: #999999;
        }

        body {
            font-family: 'Geologica', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            transition: all 0.3s ease;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2.5rem;
            margin: 0;
            padding: 0;
            position: absolute;
            left: 42%;
            transform: translateX(-50%);
        }

        .nav-link {
            color: #94a3b8;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.3s ease;
            position: relative;
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link:hover {
            color: #ffffff;
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #60a5fa;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(96, 165, 250, 0.4);
        }

        .user-panel {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--dark-bg);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            min-width: 200px;
            padding: 0.5rem 0;
            margin-top: 0.5rem;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: background 0.3s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background: rgba(74, 144, 226, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .customer-panel-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            min-height: calc(100vh - 200px);
        }

        .panel-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .panel-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ffffff, #b3d9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .panel-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .add-key-section {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .add-key-form {
            display: grid;
            grid-template-columns: 2fr 3fr 2fr 3fr auto;
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            padding: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .keys-table {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            overflow: hidden;
        }

        .table-header {
            background: rgba(74, 144, 226, 0.1);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: rgba(74, 144, 226, 0.05);
            padding: 1rem;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .table tr:hover {
            background: rgba(74, 144, 226, 0.05);
        }

        .key-display {
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: var(--success-color);
            color: white;
        }

        .status-expired {
            background: var(--error-color);
            color: white;
        }

        .hwid-reset-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .hwid-reset-btn.available {
            background: var(--primary-color);
            color: white;
        }

        .hwid-reset-btn.available:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .hwid-reset-btn.pending {
            background: var(--text-muted);
            color: white;
            cursor: not-allowed;
        }

        .hwid-reset-btn.success {
            background: var(--success-color);
            color: white;
            cursor: pointer;
        }

        .delete-key-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-key-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .admin-panel {
            margin-top: 3rem;
        }

        .admin-section {
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            margin-bottom: 2rem;
        }

        .admin-header {
            background: rgba(74, 144, 226, 0.2);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--primary-color);
        }

        .admin-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .request-item {
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-info {
            flex: 1;
        }

        .request-user {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .request-key {
            font-family: 'Courier New', monospace;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .request-time {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .approve-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .approve-btn:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        .user-item {
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr 1fr 2fr auto;
            gap: 1rem;
            align-items: center;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .user-keys {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .online-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .online {
            background: var(--success-color);
            color: white;
        }

        .offline {
            background: var(--text-muted);
            color: white;
        }

        .footer {
            background: #0A0A0A;
            border-top: 3px solid #4a90e2;
            position: relative;
            z-index: 10;
            margin-top: 4rem;
            box-shadow: 0 -3px 15px rgba(74, 144, 226, 0.4);
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 40px 40px 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
        }

        .footer-section h3 {
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
        }

        .footer-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .footer-links li a {
            color: #999;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .footer-links li a:hover {
            color: #4a90e2;
        }

        .footer-bottom {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 40px;
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-copyright {
            color: #666;
            font-size: 0.8rem;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @media (max-width: 768px) {
            .add-key-form {
                grid-template-columns: 1fr;
            }
            
            .table-wrapper {
                font-size: 0.8rem;
            }
            
            .user-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <a href="index.html" class="logo">
                <img src="https://i.imgur.com/AMPTf1r.png" alt="Varp Logo">
                VARP
            </a>
            
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="index.html#products" class="nav-link">Products</a></li>
                <li><a href="https://varp.gay/reviews" class="nav-link">Reviews</a></li>
                <li><a href="https://varp.gay/status" class="nav-link">Status</a></li>
                <li><a href="https://discord.gg/varpud" class="nav-link" target="_blank">Discord</a></li>
            </ul>
            
            <div class="auth-buttons">
                <div id="userPanel" class="user-panel">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="username">User</span>
                    <button id="userDropdownBtn" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <button class="dropdown-item" onclick="window.location.href='index.html'">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="dropdown-item" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Customer Panel Content -->
    <div class="customer-panel-container">
        <div class="panel-header">
            <h1 class="panel-title">Customer Panel</h1>
            <p class="panel-subtitle">Manage your license keys and HWID resets</p>
        </div>

        <!-- Add Key Section -->
        <div class="add-key-section" id="addKeySection">
            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary);">Add New License Key</h3>
            <form class="add-key-form" id="addKeyForm">
                <div class="form-group">
                    <label class="form-label">Product</label>
                    <select class="form-select" id="productSelect" required>
                        <option value="">Select Product</option>
                        <option value="fortnite-private">Fortnite Private</option>
                        <option value="fortnite-public">Fortnite Public</option>
                        <option value="permanent-spoofer">Permanent Spoofer</option>
                        <option value="temporary-spoofer">Temporary Spoofer</option>
                        <option value="bo6-external">BO6 External</option>
                        <option value="apex-external">Apex External</option>
                        <option value="rust-external">Rust External</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">License Key</label>
                    <input type="text" class="form-input" id="licenseKeyInput" placeholder="VARP-****-****-**** or ****-****-****-****" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Variant</label>
                    <select class="form-select" id="variantSelect" required>
                        <option value="">Select Variant</option>
                        <option value="1-day">1 Day</option>
                        <option value="7-days">7 Days</option>
                        <option value="30-days">30 Days</option>
                        <option value="lifetime">Lifetime</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Note (Optional)</label>
                    <input type="text" class="form-input" id="noteInput" placeholder="Optional note">
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Add Key
                </button>
            </form>
        </div>

        <!-- Keys Table -->
        <div class="keys-table" id="userKeysSection">
            <div class="table-header">
                <h3 class="table-title">Your License Keys</h3>
            </div>
            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>License Key</th>
                            <th>Variant</th>
                            <th>Status</th>
                            <th>Note</th>
                            <th>HWID Reset</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="keysTableBody">
                        <!-- Keys will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Panel (only visible for admin) -->
        <div class="admin-panel hidden" id="adminPanel">
            <!-- HWID Requests -->
            <div class="admin-section">
                <div class="admin-header">
                    <h3 class="admin-title">
                        <i class="fas fa-shield-alt"></i>
                        Active HWID Reset Requests
                    </h3>
                </div>
                <div id="hwidRequestsList">
                    <!-- HWID requests will be dynamically added here -->
                </div>
            </div>

            <!-- All License Keys -->
            <div class="admin-section">
                <div class="admin-header">
                    <h3 class="admin-title">
                        <i class="fas fa-key"></i>
                        All License Keys
                    </h3>
                </div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Product</th>
                                <th>License Key</th>
                                <th>Variant</th>
                                <th>Status</th>
                                <th>Note</th>
                                <th>HWID Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminKeysTableBody">
                            <!-- All keys will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- All Users -->
            <div class="admin-section">
                <div class="admin-header">
                    <h3 class="admin-title">
                        <i class="fas fa-users"></i>
                        All Users
                    </h3>
                </div>
                <div id="allUsersList">
                    <!-- Users will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Varp Menu</h3>
                <ul class="footer-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#products">Products</a></li>
                    <li><a href="https://discord.gg/varpud" target="_blank">Contact</a></li>
                    <li><a href="https://discord.gg/varpud" target="_blank">Discord</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Legal</h3>
                <ul class="footer-links">
                    <li><a href="#">Terms of Service</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Refund Policy</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="footer-copyright">
                <p>&copy; 2025, Varp Powered by VARP</p>
            </div>
        </div>
    </footer>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBSQNdHH9XAfHyHwWI8iFS2CdsTjv0NMoo",
            authDomain: "authentication-website-c7ab3.firebaseapp.com",
            projectId: "authentication-website-c7ab3",
            storageBucket: "authentication-website-c7ab3.firebasestorage.app",
            messagingSenderId: "380309135971",
            appId: "1:380309135971:web:6e5d75a22f06ff310dce56",
            measurementId: "G-SSKDR565XT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const userPanel = document.getElementById('userPanel');
        const userDropdownBtn = document.getElementById('userDropdownBtn');
        const userDropdown = document.getElementById('userDropdown');
        const logoutBtn = document.getElementById('logoutBtn');
        const addKeyForm = document.getElementById('addKeyForm');
        const addKeySection = document.getElementById('addKeySection');
        const userKeysSection = document.getElementById('userKeysSection');
        const keysTableBody = document.getElementById('keysTableBody');
        const adminPanel = document.getElementById('adminPanel');
        const hwidRequestsList = document.getElementById('hwidRequestsList');
        const allUsersList = document.getElementById('allUsersList');
        const adminKeysTableBody = document.getElementById('adminKeysTableBody');

        let currentUser = null;
        let isAdmin = false;

        // Show loading screen initially
        loadingScreen.style.display = 'flex';

        // Check authentication and redirect if not logged in
        auth.onAuthStateChanged((user) => {
            // Hide loading screen after auth check
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 1000);

            if (user) {
                currentUser = user;
                updateUserUI(user);
                checkAdminStatus(user);
                
                if (!isAdmin) {
                    loadUserKeys();
                }
                
                setupRealtimeListeners();
            } else {
                window.location.href = 'index.html';
            }
        });

        function updateUserUI(user) {
            const username = user.displayName || user.email.split('@')[0];
            document.getElementById('username').textContent = username;
            document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
        }

        function checkAdminStatus(user) {
            isAdmin = user.email === 'varp.administrator@op.pl';
            console.log('Checking admin status for:', user.email, 'isAdmin:', isAdmin);
            
            if (isAdmin) {
                addKeySection.style.display = 'none';
                userKeysSection.style.display = 'none';
                adminPanel.classList.remove('hidden');
                
                console.log('Loading admin data...');
                loadHwidRequests();
                loadAllUsers();
                loadAllKeys();
            } else {
                addKeySection.style.display = 'block';
                userKeysSection.style.display = 'block';
                adminPanel.classList.add('hidden');
            }
        }

        // User dropdown
        userDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });

        document.addEventListener('click', () => {
            userDropdown.classList.remove('active');
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        });

        // Add key form handler - only for non-admin users
        addKeyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (isAdmin) {
                alert('Administrators cannot add license keys.');
                return;
            }
            
            console.log('=== ADDING KEY STARTED ===');
            
            const product = document.getElementById('productSelect').value;
            const licenseKey = document.getElementById('licenseKeyInput').value.trim();
            const variant = document.getElementById('variantSelect').value;
            const note = document.getElementById('noteInput').value.trim();

            // Validate key format
            const keyPattern = /^(VARP-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}|[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4})$/;
            if (!keyPattern.test(licenseKey)) {
                alert('Invalid key format. Use VARP-****-****-**** or ****-****-****-****');
                return;
            }

            // Check if key already exists
            try {
                const existingKey = await db.collection('userKeys')
                    .where('licenseKey', '==', licenseKey)
                    .get();
                
                if (!existingKey.empty) {
                    alert('This license key already exists in the system!');
                    return;
                }
            } catch (error) {
                console.error('Error checking existing key:', error);
            }

            try {
                const keyData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    product: product,
                    licenseKey: licenseKey,
                    variant: variant,
                    note: note || '',
                    status: 'active',
                    hwidResetStatus: 'available',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastHwidReset: null
                };
                
                const docRef = await db.collection('userKeys').add(keyData);
                console.log('Key added successfully with ID:', docRef.id);
                
                alert('License key added successfully!');
                addKeyForm.reset();
                
                setTimeout(() => {
                    loadUserKeys();
                }, 1000);
                
            } catch (error) {
                console.error('Error adding key:', error);
                alert('Failed to add key: ' + error.message);
            }
        });

        // Load user keys
        async function loadUserKeys() {
            if (!currentUser || isAdmin) return;

            try {
                console.log('Loading keys for user:', currentUser.uid);
                
                const snapshot = await db.collection('userKeys')
                    .where('userId', '==', currentUser.uid)
                    .get();

                keysTableBody.innerHTML = '';

                if (snapshot.empty) {
                    keysTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">No license keys found. Add your first key above!</td></tr>';
                    return;
                }

                const keysArray = [];
                snapshot.forEach(doc => {
                    keysArray.push({ id: doc.id, data: doc.data() });
                });
                
                keysArray.sort((a, b) => {
                    const aTime = a.data.createdAt ? a.data.createdAt.toMillis() : 0;
                    const bTime = b.data.createdAt ? b.data.createdAt.toMillis() : 0;
                    return bTime - aTime;
                });

                keysArray.forEach(({ id, data }) => {
                    const row = createKeyRow(id, data);
                    keysTableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading keys:', error);
                keysTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--error-color); padding: 2rem;">Error loading keys</td></tr>';
            }
        }

        // Create key table row
        function createKeyRow(keyId, keyData) {
            const row = document.createElement('tr');
            
            const statusClass = keyData.status === 'active' ? 'status-active' : 'status-expired';
            const hwidButtonClass = getHwidButtonClass(keyData.hwidResetStatus);
            const hwidButtonText = getHwidButtonText(keyData.hwidResetStatus);
            const hwidButtonIcon = getHwidButtonIcon(keyData.hwidResetStatus);
            
            row.innerHTML = `
                <td>${getProductDisplayName(keyData.product)}</td>
                <td><div class="key-display">${keyData.licenseKey}</div></td>
                <td>${keyData.variant}</td>
                <td><span class="status-badge ${statusClass}">${keyData.status}</span></td>
                <td>${keyData.note || '-'}</td>
                <td>
                    <button class="hwid-reset-btn ${hwidButtonClass}" 
                            ${keyData.hwidResetStatus === 'pending' ? 'disabled' : ''}>
                        <i class="fas ${hwidButtonIcon}"></i>
                        ${hwidButtonText}
                    </button>
                </td>
                <td>
                    <button class="delete-key-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            const hwidButton = row.querySelector('.hwid-reset-btn');
            const deleteButton = row.querySelector('.delete-key-btn');

            hwidButton.addEventListener('click', () => handleHwidReset(keyId, keyData));
            deleteButton.addEventListener('click', () => handleDeleteKey(keyId));

            return row;
        }

        function getProductDisplayName(product) {
            const names = {
                'fortnite-private': 'Fortnite Private',
                'fortnite-public': 'Fortnite Public',
                'permanent-spoofer': 'Permanent Spoofer',
                'temporary-spoofer': 'Temporary Spoofer',
                'bo6-external': 'BO6 External',
                'apex-external': 'Apex External',
                'rust-external': 'Rust External'
            };
            return names[product] || product;
        }

        function getHwidButtonClass(status) {
            switch (status) {
                case 'available': return 'available';
                case 'pending': return 'pending';
                case 'success': return 'success';
                default: return 'available';
            }
        }

        function getHwidButtonText(status) {
            switch (status) {
                case 'available': return 'Reset HWID';
                case 'pending': return 'Pending...';
                case 'success': return 'Completed';
                default: return 'Reset HWID';
            }
        }

        function getHwidButtonIcon(status) {
            switch (status) {
                case 'available': return 'fa-refresh';
                case 'pending': return 'fa-clock';
                case 'success': return 'fa-check';
                default: return 'fa-refresh';
            }
        }

        // Handle HWID reset request
        async function handleHwidReset(keyId, keyData) {
            if (keyData.hwidResetStatus === 'pending') return;
            
            if (keyData.hwidResetStatus === 'success') {
                try {
                    await db.collection('userKeys').doc(keyId).update({
                        hwidResetStatus: 'available'
                    });
                    loadUserKeys();
                } catch (error) {
                    console.error('Error resetting HWID status:', error);
                    alert('Failed to reset status');
                }
                return;
            }

            try {
                await db.collection('hwidRequests').add({
                    keyId: keyId,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    licenseKey: keyData.licenseKey,
                    product: keyData.product,
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                });

                await db.collection('userKeys').doc(keyId).update({
                    hwidResetStatus: 'pending'
                });

                loadUserKeys();
                alert('HWID reset request submitted. Wait for admin approval.');
            } catch (error) {
                console.error('Error creating HWID request:', error);
                alert('Failed to create HWID reset request');
            }
        }

        // Handle delete key
        async function handleDeleteKey(keyId) {
            if (confirm('Are you sure you want to delete this license key?')) {
                try {
                    await db.collection('userKeys').doc(keyId).delete();
                    loadUserKeys();
                } catch (error) {
                    console.error('Error deleting key:', error);
                    alert('Failed to delete key');
                }
            }
        }

        // Load all keys (admin only)
        async function loadAllKeys() {
            if (!isAdmin) return;

            try {
                console.log('Loading all keys for admin...');
                const snapshot = await db.collection('userKeys').get();

                adminKeysTableBody.innerHTML = '';

                if (snapshot.empty) {
                    adminKeysTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-muted); padding: 2rem;">No license keys found in system</td></tr>';
                    return;
                }

                const keysArray = [];
                snapshot.forEach(doc => {
                    keysArray.push({ id: doc.id, data: doc.data() });
                });
                
                keysArray.sort((a, b) => {
                    const aTime = a.data.createdAt ? a.data.createdAt.toMillis() : 0;
                    const bTime = b.data.createdAt ? b.data.createdAt.toMillis() : 0;
                    return bTime - aTime;
                });

                keysArray.forEach(({ id, data }) => {
                    const row = createAdminKeyRow(id, data);
                    adminKeysTableBody.appendChild(row);
                });

                console.log('All keys loaded for admin');
            } catch (error) {
                console.error('Error loading all keys:', error);
                adminKeysTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--error-color); padding: 2rem;">Error loading keys</td></tr>';
            }
        }

        // Create admin key table row
        function createAdminKeyRow(keyId, keyData) {
            const row = document.createElement('tr');
            
            const statusClass = keyData.status === 'active' ? 'status-active' : 'status-expired';
            const hwidStatusClass = getHwidButtonClass(keyData.hwidResetStatus);
            const createdAt = keyData.createdAt ? new Date(keyData.createdAt.toDate()).toLocaleDateString() : 'Unknown';
            
            row.innerHTML = `
                <td>${keyData.userEmail || 'Unknown'}</td>
                <td>${getProductDisplayName(keyData.product)}</td>
                <td><div class="key-display">${keyData.licenseKey}</div></td>
                <td>${keyData.variant}</td>
                <td><span class="status-badge ${statusClass}">${keyData.status}</span></td>
                <td>${keyData.note || '-'}</td>
                <td><span class="status-badge ${hwidStatusClass}">${keyData.hwidResetStatus}</span></td>
                <td>${createdAt}</td>
                <td>
                    <button class="delete-key-btn" onclick="handleAdminDeleteKey('${keyId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            return row;
        }

        // Handle admin delete key
        async function handleAdminDeleteKey(keyId) {
            if (confirm('Are you sure you want to delete this license key? This action cannot be undone.')) {
                try {
                    await db.collection('userKeys').doc(keyId).delete();
                    loadAllKeys();
                    alert('License key deleted successfully');
                } catch (error) {
                    console.error('Error deleting key:', error);
                    alert('Failed to delete key');
                }
            }
        }

        // Load HWID requests (admin only)
        async function loadHwidRequests() {
            if (!isAdmin) return;

            try {
                console.log('=== LOADING HWID REQUESTS ===');
                
                const allRequestsSnapshot = await db.collection('hwidRequests').get();
                console.log('Total HWID requests in database:', allRequestsSnapshot.size);
                
                const snapshot = await db.collection('hwidRequests')
                    .where('status', '==', 'pending')
                    .get();

                console.log('Found', snapshot.size, 'pending HWID requests');
                
                hwidRequestsList.innerHTML = '';

                if (snapshot.empty) {
                    hwidRequestsList.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No pending HWID reset requests</div>';
                    return;
                }

                const requestsArray = [];
                snapshot.forEach(doc => {
                    requestsArray.push({ id: doc.id, data: doc.data() });
                });
                
                requestsArray.sort((a, b) => {
                    const aTime = a.data.requestedAt ? a.data.requestedAt.toMillis() : 0;
                    const bTime = b.data.requestedAt ? b.data.requestedAt.toMillis() : 0;
                    return bTime - aTime;
                });

                requestsArray.forEach(({ id, data }) => {
                    const requestElement = createRequestElement(id, data);
                    hwidRequestsList.appendChild(requestElement);
                });
                
            } catch (error) {
                console.error('Error loading HWID requests:', error);
                hwidRequestsList.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--error-color);">Error loading HWID requests</div>';
            }
        }

        // Create request element
        function createRequestElement(requestId, requestData) {
            const div = document.createElement('div');
            div.className = 'request-item';

            const timeAgo = getTimeAgo(requestData.requestedAt);

            div.innerHTML = `
                <div class="request-info">
                    <div class="request-user">${requestData.userEmail}</div>
                    <div class="request-key">${requestData.licenseKey} (${getProductDisplayName(requestData.product)})</div>
                    <div class="request-time">${timeAgo}</div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="approve-btn">
                        <i class="fas fa-check"></i>
                        Approve
                    </button>
                    <button class="approve-btn" style="background: var(--error-color);" onclick="rejectHwidRequest('${requestId}')">
                        <i class="fas fa-times"></i>
                        Reject
                    </button>
                </div>
            `;

            const approveButton = div.querySelector('.approve-btn');
            approveButton.addEventListener('click', () => approveHwidRequest(requestId, requestData));

            return div;
        }

        // Approve HWID request
        async function approveHwidRequest(requestId, requestData) {
            try {
                await db.collection('hwidRequests').doc(requestId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: currentUser.email
                });

                await db.collection('userKeys').doc(requestData.keyId).update({
                    hwidResetStatus: 'success',
                    lastHwidReset: firebase.firestore.FieldValue.serverTimestamp()
                });

                loadHwidRequests();
                loadAllKeys();
                showNotification('Request Approved', `HWID reset approved for ${requestData.userEmail}`, 'success');
                
            } catch (error) {
                console.error('Error approving HWID request:', error);
                alert('Failed to approve request');
            }
        }

        // Reject HWID request
        async function rejectHwidRequest(requestId) {
            try {
                const requestDoc = await db.collection('hwidRequests').doc(requestId).get();
                const requestData = requestDoc.data();

                await db.collection('hwidRequests').doc(requestId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rejectedBy: currentUser.email
                });

                await db.collection('userKeys').doc(requestData.keyId).update({
                    hwidResetStatus: 'available'
                });

                loadHwidRequests();
                loadAllKeys();
                showNotification('Request Rejected', `HWID reset rejected for ${requestData.userEmail}`, 'error');
                
            } catch (error) {
                console.error('Error rejecting HWID request:', error);
                alert('Failed to reject request');
            }
        }

        // Load all users (admin only)
        async function loadAllUsers() {
            if (!isAdmin) return;

            try {
                console.log('=== LOADING ALL USERS ===');
                
                const keysSnapshot = await db.collection('userKeys').get();
                console.log('Total keys found for user extraction:', keysSnapshot.size);
                
                const usersMap = new Map();
                
                keysSnapshot.forEach(doc => {
                    const keyData = doc.data();
                    if (keyData.userId && keyData.userEmail) {
                        if (!usersMap.has(keyData.userId)) {
                            usersMap.set(keyData.userId, {
                                userId: keyData.userId,
                                email: keyData.userEmail,
                                username: keyData.userEmail.split('@')[0],
                                createdAt: keyData.createdAt || null,
                                keysCount: 0
                            });
                        }
                        usersMap.get(keyData.userId).keysCount++;
                    }
                });
                
                console.log('Unique users found:', usersMap.size);
                
                allUsersList.innerHTML = '';

                if (usersMap.size === 0) {
                    allUsersList.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No users found</div>';
                    return;
                }

                const usersArray = Array.from(usersMap.values());
                usersArray.sort((a, b) => a.email.localeCompare(b.email));

                usersArray.forEach(userData => {
                    const userElement = createUserElement(userData.userId, userData);
                    allUsersList.appendChild(userElement);
                });
                
                console.log('Users loaded successfully');
            } catch (error) {
                console.error('Error loading users:', error);
                allUsersList.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--error-color);">Error loading users</div>';
            }
        }

        // Create user element
        function createUserElement(userId, userData) {
            const div = document.createElement('div');
            div.className = 'user-item';

            const isOnline = Math.random() > 0.5;
            const lastSeen = userData.createdAt ? 
                new Date(userData.createdAt.toDate()).toLocaleDateString() : 
                'Unknown';

            div.innerHTML = `
                <div class="user-name">${userData.username || userData.email.split('@')[0]}</div>
                <div class="user-email">${userData.email}</div>
                <div class="user-keys">${userData.keysCount || 0} license keys  Joined: ${lastSeen}</div>
                <div class="online-status ${isOnline ? 'online' : 'offline'}">
                    ${isOnline ? 'Online' : 'Offline'}
                </div>
            `;

            return div;
        }

        // Setup real-time listeners
        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            console.log('Setting up real-time listeners for user:', currentUser.uid, 'isAdmin:', isAdmin);

            if (!isAdmin) {
                db.collection('userKeys')
                    .where('userId', '==', currentUser.uid)
                    .onSnapshot((snapshot) => {
                        console.log('User keys updated via real-time listener');
                        
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'modified') {
                                const data = change.doc.data();
                                if (data.hwidResetStatus === 'success') {
                                    const now = new Date();
                                    const lastUpdate = data.lastHwidReset ? data.lastHwidReset.toDate() : null;
                                    if (lastUpdate && (now - lastUpdate) < 10000) {
                                        showNotification('HWID Reset Approved!', 'Your HWID reset request has been approved by admin.', 'success');
                                    }
                                }
                            }
                        });
                        
                        loadUserKeys();
                    }, (error) => {
                        console.error('Error in keys listener:', error);
                    });
            }

            if (isAdmin) {
                console.log('Setting up admin real-time listeners');
                
                db.collection('userKeys').onSnapshot((snapshot) => {
                    console.log('All keys updated via real-time listener');
                    loadAllKeys();
                    loadAllUsers();
                }, (error) => {
                    console.error('Error in all keys listener:', error);
                });
                
                db.collection('hwidRequests').onSnapshot((snapshot) => {
                    console.log('HWID requests updated via real-time listener');
                    loadHwidRequests();
                }, (error) => {
                    console.error('Error in HWID requests listener:', error);
                });
            }
        }

        // Show notification function
        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--error-color)' : 'var(--primary-color)'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.5rem;">${title}</div>
                <div style="font-size: 0.9rem;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Utility function to get time ago
        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const now = new Date();
            const requestTime = timestamp.toDate();
            const diffInMinutes = Math.floor((now - requestTime) / (1000 * 60));

            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes} minutes ago`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} hours ago`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays} days ago`;
        }

        // Auto-refresh admin data
        setInterval(() => {
            if (isAdmin) {
                console.log('Auto-refresh admin data...');
                loadHwidRequests();
                loadAllUsers();
                loadAllKeys();
            }
        }, 30000);

        // Make functions global
        window.handleAdminDeleteKey = handleAdminDeleteKey;
        window.rejectHwidRequest = rejectHwidRequest;

        console.log('Customer Panel loaded successfully!');
    </script>
</body>
</html>